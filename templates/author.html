{% extends "base.html" %}

{% block title %}{{ author.name }} - BookScout{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Authors</a></li>
                <li class="breadcrumb-item active">{{ author.name }}</li>
            </ol>
        </nav>
        <h1>{{ author.name }}</h1>
        {% if author.last_scanned %}
            <p class="text-muted">Last scanned: {{ author.last_scanned[:16] }}</p>
        {% endif %}
        <div class="btn-group" role="group">
            <a href="{{ url_for('scan_author', author_id=author.id) }}" class="btn btn-success">
                <i class="bi bi-arrow-repeat"></i> Re-scan Now
            </a>
            {% if show_missing_only %}
                <a href="{{ url_for('view_author', author_id=author.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-list"></i> Show All Books
                </a>
            {% else %}
                <a href="{{ url_for('view_author', author_id=author.id, missing='true') }}" class="btn btn-outline-warning">
                    <i class="bi bi-funnel"></i> Show Missing Only
                </a>
            {% endif %}
            <a href="{{ url_for('view_duplicates', author_id=author.id) }}" class="btn btn-outline-danger">
                <i class="bi bi-files"></i> Manage Duplicates
            </a>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editAuthorModal">
                <i class="bi bi-pencil"></i> Edit Name
            </button>
        </div>
    </div>
</div>

<!-- Edit Author Modal -->
<div class="modal fade" id="editAuthorModal" tabindex="-1" aria-labelledby="editAuthorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAuthorModalLabel">Edit Author Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('edit_author', author_id=author.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="author_name" class="form-label">Author Name</label>
                        <input type="text" class="form-control" id="author_name" name="author_name" 
                               value="{{ author.name }}" required>
                        <div class="form-text">Update if the import was incorrect or you want to fix spelling</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if books %}
<div class="row mb-3">
    <div class="col">
        <div class="alert alert-info">
            <strong>{{ books|length }}</strong> books found
            <span class="ms-3">
                <i class="bi bi-check-circle text-success"></i> 
                <strong>{{ books|selectattr('have_it', 'equalto', 1)|list|length }}</strong> in library
            </span>
            <span class="ms-3">
                <i class="bi bi-x-circle text-warning"></i> 
                <strong>{{ books|selectattr('have_it', 'equalto', 0)|list|length }}</strong> missing
            </span>
        </div>
    </div>
</div>

{% for series_name in (books_by_series.keys()|reject('equalto', 'Standalone')|sort) + ['Standalone']|select('in', books_by_series.keys())|list %}
    {% set series_books = books_by_series[series_name] %}
    <div class="mb-4">
        <h4 class="border-bottom pb-2">
            {% if series_name == 'Standalone' %}
                <i class="bi bi-book"></i> Standalone Books
            {% else %}
                <i class="bi bi-collection"></i> {{ series_name }}
            {% endif %}
            <span class="badge bg-secondary ms-2">{{ series_books|length }}</span>
        </h4>
        <div class="row">
    {% for book in series_books %}
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <div class="card book-card h-100">
            <div class="position-relative">
                {% if book.cover_url %}
                    <img src="{{ book.cover_url }}" class="card-img-top cover-img" alt="{{ book.title }}">
                {% else %}
                    <div class="card-img-top cover-img bg-secondary d-flex align-items-center justify-content-center">
                        <i class="bi bi-book text-white" style="font-size: 3rem;"></i>
                    </div>
                {% endif %}
                <button class="btn btn-sm position-absolute top-0 end-0 m-2 toggle-owned-btn {% if book.have_it %}btn-success{% else %}btn-outline-light{% endif %}" 
                        data-book-id="{{ book.id }}"
                        title="{% if book.have_it %}Mark as not owned{% else %}Mark as owned{% endif %}">
                    <i class="bi bi-{% if book.have_it %}check-circle-fill{% else %}circle{% endif %}"></i>
                </button>
            </div>
            <div class="card-body">
                <h6 class="card-title">{{ book.title }}</h6>
                {% if book.subtitle %}
                    <p class="card-text text-muted small">{{ book.subtitle }}</p>
                {% endif %}
                
                <div class="mb-2">
                    {% if book.release_date %}
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ book.release_date[:4] }}
                        </small>
                    {% endif %}
                    {% if book.format %}
                        <small class="badge bg-info ms-1">{{ book.format }}</small>
                    {% endif %}
                </div>
                
                <div class="mb-2">
                    {% set sources = book.source %}
                    {% if sources %}
                        {% if '[' in sources %}
                            {% set source_list = sources.replace('[', '').replace(']', '').replace('"', '').replace("'", '').split(',') %}
                            {% for source in source_list %}
                                <span class="badge bg-secondary source-badge">{{ source.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="badge bg-secondary source-badge">{{ sources }}</span>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% if book.isbn or book.isbn13 %}
                    <small class="text-muted d-block">
                        ISBN: {{ book.isbn13 or book.isbn }}
                    </small>
                {% endif %}
                
                {% if book.asin %}
                    <small class="text-muted d-block">
                        ASIN: {{ book.asin }}
                    </small>
                {% endif %}
                
                {% if not book.have_it %}
                    <button class="btn btn-sm btn-primary mt-2 w-100 unified-search-btn" 
                            data-book-title="{{ book.title }}"
                            data-author-name="{{ author.name }}">
                        <i class="bi bi-search"></i> Search
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
        </div>
    </div>
{% endfor %}
{% else %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> No books found yet. Click "Re-scan Now" to search for books.
</div>
{% endif %}

<!-- Search Results Modal -->
<div class="modal fade" id="searchResultsModal" tabindex="-1" aria-labelledby="searchResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchResultsModalLabel">Search Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="searchLoadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching Prowlarr and Jackett...</p>
                </div>
                
                <div id="searchResultsContent" style="display: none;">
                    <div class="mb-3">
                        <strong id="searchResultsCount">0</strong> results found
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Title</th>
                                    <th>Indexer</th>
                                    <th>Size</th>
                                    <th>Seeders</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="searchNoResults" style="display: none;" class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No results found
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for download notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="downloadToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">BookScout</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Toggle book owned status
document.querySelectorAll('.toggle-owned-btn').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        const bookId = this.getAttribute('data-book-id');
        const btn = this;
        
        fetch(`/books/${bookId}/toggle-owned`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button appearance
                if (data.have_it) {
                    btn.classList.remove('btn-outline-light');
                    btn.classList.add('btn-success');
                    btn.querySelector('i').classList.remove('bi-circle');
                    btn.querySelector('i').classList.add('bi-check-circle-fill');
                    btn.title = 'Mark as not owned';
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-light');
                    btn.querySelector('i').classList.remove('bi-check-circle-fill');
                    btn.querySelector('i').classList.add('bi-circle');
                    btn.title = 'Mark as owned';
                }
                
                // Reload page to update counts
                setTimeout(() => location.reload(), 500);
            }
        })
        .catch(error => {
            console.error('Error toggling book status:', error);
            showToast('Failed to update book status', 'danger');
        });
    });
});

// Unified search functionality
document.querySelectorAll('.unified-search-btn').forEach(button => {
    button.addEventListener('click', function() {
        const bookTitle = this.getAttribute('data-book-title');
        const authorName = this.getAttribute('data-author-name');
        const query = `${bookTitle} ${authorName}`;
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
        modal.show();
        
        // Reset modal content
        document.getElementById('searchLoadingSpinner').style.display = 'block';
        document.getElementById('searchResultsContent').style.display = 'none';
        document.getElementById('searchNoResults').style.display = 'none';
        document.getElementById('searchResultsModalLabel').textContent = `Search Results: ${bookTitle}`;
        
        // Perform search
        fetch('/api/unified-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('searchLoadingSpinner').style.display = 'none';
            
            if (data.error) {
                document.getElementById('searchNoResults').textContent = 'Error: ' + data.error;
                document.getElementById('searchNoResults').style.display = 'block';
                return;
            }
            
            if (data.count === 0) {
                document.getElementById('searchNoResults').style.display = 'block';
                return;
            }
            
            // Display results
            displaySearchResults(data.results, data.count);
        })
        .catch(error => {
            document.getElementById('searchLoadingSpinner').style.display = 'none';
            document.getElementById('searchNoResults').textContent = 'Search failed: ' + error;
            document.getElementById('searchNoResults').style.display = 'block';
        });
    });
});

function displaySearchResults(results, count) {
    document.getElementById('searchResultsCount').textContent = count;
    document.getElementById('searchResultsContent').style.display = 'block';
    
    const tbody = document.getElementById('searchResultsTableBody');
    tbody.innerHTML = '';
    
    results.forEach(result => {
        const row = document.createElement('tr');
        
        // Source badge
        const sourceCell = document.createElement('td');
        const sourceBadge = document.createElement('span');
        sourceBadge.className = result.source === 'Prowlarr' ? 'badge bg-info' : 'badge bg-warning text-dark';
        sourceBadge.textContent = result.source;
        const typeBadge = document.createElement('span');
        typeBadge.className = result.type === 'Usenet' ? 'badge bg-primary ms-1' : 'badge bg-success ms-1';
        typeBadge.textContent = result.type;
        sourceCell.appendChild(sourceBadge);
        sourceCell.appendChild(typeBadge);
        row.appendChild(sourceCell);
        
        // Title
        const titleCell = document.createElement('td');
        titleCell.textContent = result.title;
        titleCell.style.maxWidth = '400px';
        titleCell.style.overflow = 'hidden';
        titleCell.style.textOverflow = 'ellipsis';
        titleCell.title = result.title;
        row.appendChild(titleCell);
        
        // Indexer
        const indexerCell = document.createElement('td');
        indexerCell.textContent = result.indexer || 'N/A';
        row.appendChild(indexerCell);
        
        // Size
        const sizeCell = document.createElement('td');
        sizeCell.textContent = result.size_display || 'N/A';
        row.appendChild(sizeCell);
        
        // Seeders (only for torrents)
        const seedersCell = document.createElement('td');
        if (result.type === 'Torrent') {
            const seedersSpan = document.createElement('span');
            seedersSpan.className = result.seeders > 10 ? 'text-success fw-bold' : (result.seeders > 0 ? 'text-warning' : 'text-danger');
            seedersSpan.textContent = result.seeders;
            seedersCell.appendChild(seedersSpan);
        } else {
            seedersCell.textContent = 'N/A';
        }
        row.appendChild(seedersCell);
        
        // Action button
        const actionCell = document.createElement('td');
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn btn-sm btn-primary';
        downloadBtn.innerHTML = '<i class="bi bi-download"></i> Download';
        downloadBtn.onclick = () => sendToDownloadClient(result);
        actionCell.appendChild(downloadBtn);
        row.appendChild(actionCell);
        
        tbody.appendChild(row);
    });
}

function sendToDownloadClient(result) {
    const downloadUrl = result.magnet_url || result.download_url;
    
    if (!downloadUrl) {
        showToast('Error: No download URL available', 'danger');
        return;
    }
    
    fetch('/api/download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            download_url: downloadUrl,
            title: result.title,
            type: result.type
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Download failed: ' + error, 'danger');
    });
}

function showToast(message, type) {
    const toastEl = document.getElementById('downloadToast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toastMessage.className = 'toast-body';
    
    if (type === 'success') {
        toastMessage.classList.add('bg-success', 'text-white');
    } else {
        toastMessage.classList.add('bg-danger', 'text-white');
    }
    
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}
</script>
{% endblock %}
