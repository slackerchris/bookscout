{% extends "base.html" %}

{% block title %}{{ author.name }} - BookScout{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Authors</a></li>
                <li class="breadcrumb-item active">{{ author.name }}</li>
            </ol>
        </nav>
        <h1>{{ author.name }}</h1>
        {% if author.last_scanned %}
            <p class="text-muted">Last scanned: {{ author.last_scanned[:16] }}</p>
        {% endif %}
        <div class="btn-group" role="group">
            <a href="{{ url_for('scan_author', author_id=author.id) }}" class="btn btn-success">
                <i class="bi bi-arrow-repeat"></i> Re-scan Now
            </a>
            {% if show_missing_only %}
                <a href="{{ url_for('view_author', author_id=author.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-list"></i> Show All Books
                </a>
            {% else %}
                <a href="{{ url_for('view_author', author_id=author.id, missing='true') }}" class="btn btn-outline-warning">
                    <i class="bi bi-funnel"></i> Show Missing Only
                </a>
            {% endif %}
            <a href="{{ url_for('view_duplicates', author_id=author.id) }}" class="btn btn-outline-danger">
                <i class="bi bi-files"></i> Manage Duplicates
            </a>
            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#addBookModal">
                <i class="bi bi-plus-circle"></i> Add Book Manually
            </button>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editAuthorModal">
                <i class="bi bi-pencil"></i> Edit Name
            </button>
        </div>
    </div>
</div>

<!-- Add Book Manually Modal -->
<div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBookModalLabel">Add Book Manually</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('add_book_manually', author_id=author.id) }}" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="book_title" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="book_title" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="book_subtitle" class="form-label">Subtitle</label>
                                <input type="text" class="form-control" id="book_subtitle" name="subtitle">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="book_series" class="form-label">Series Name</label>
                                <input type="text" class="form-control" id="book_series" name="series" placeholder="e.g., Arcane Ascension">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="book_series_position" class="form-label">Series Position</label>
                                <input type="text" class="form-control" id="book_series_position" name="series_position" placeholder="e.g., 1 or 1.5">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="book_isbn" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="book_isbn" name="isbn">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="book_isbn13" class="form-label">ISBN-13</label>
                                <input type="text" class="form-control" id="book_isbn13" name="isbn13">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="book_asin" class="form-label">ASIN</label>
                                <input type="text" class="form-control" id="book_asin" name="asin">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="book_release_date" class="form-label">Release Date</label>
                                <input type="text" class="form-control" id="book_release_date" name="release_date" placeholder="YYYY-MM-DD or YYYY">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="book_format" class="form-label">Format</label>
                                <select class="form-select" id="book_format" name="format">
                                    <option value="">-- Select Format --</option>
                                    <option value="audiobook">Audiobook</option>
                                    <option value="ebook">eBook</option>
                                    <option value="hardcover">Hardcover</option>
                                    <option value="paperback">Paperback</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="book_cover_url" class="form-label">Cover Image URL</label>
                        <input type="url" class="form-control" id="book_cover_url" name="cover_url" placeholder="https://...">
                    </div>
                    
                    <div class="mb-3">
                        <label for="book_description" class="form-label">Description</label>
                        <textarea class="form-control" id="book_description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="book_have_it" name="have_it" value="1">
                        <label class="form-check-label" for="book_have_it">
                            I already own this book
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Book
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Author Modal -->
<div class="modal fade" id="editAuthorModal" tabindex="-1" aria-labelledby="editAuthorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAuthorModalLabel">Edit Author Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('edit_author', author_id=author.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="author_name" class="form-label">Author Name</label>
                        <input type="text" class="form-control" id="author_name" name="author_name" 
                               value="{{ author.name }}" required>
                        <div class="form-text">Update if the import was incorrect or you want to fix spelling</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if books %}
<div class="row mb-3">
    <div class="col">
        <div class="alert alert-info">
            <strong>{{ books|length }}</strong> books found
            <span class="ms-3">
                <i class="bi bi-check-circle text-success"></i> 
                <strong>{{ books|selectattr('have_it', 'equalto', 1)|list|length }}</strong> in library
            </span>
            <span class="ms-3">
                <i class="bi bi-x-circle text-warning"></i> 
                <strong>{{ books|selectattr('have_it', 'equalto', 0)|list|length }}</strong> missing
            </span>
        </div>
    </div>
</div>

{% for series_name in (books_by_series.keys()|reject('equalto', 'Standalone')|sort) + ['Standalone']|select('in', books_by_series.keys())|list %}
    {% set series_books = books_by_series[series_name] %}
    <div class="mb-4">
        <h4 class="border-bottom pb-2">
            {% if series_name == 'Standalone' %}
                <i class="bi bi-book"></i> Standalone Books
            {% else %}
                <i class="bi bi-collection"></i> {{ series_name }}
            {% endif %}
            <span class="badge bg-secondary ms-2">{{ series_books|length }}</span>
        </h4>
        <div class="row">
    {% for book in series_books %}
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <div class="card book-card h-100">
            <div class="position-relative">
                {% if book.cover_url %}
                    <img src="{{ book.cover_url }}" class="card-img-top cover-img" alt="{{ book.title }}">
                {% else %}
                    <div class="card-img-top cover-img bg-secondary d-flex align-items-center justify-content-center">
                        <i class="bi bi-book text-white" style="font-size: 3rem;"></i>
                    </div>
                {% endif %}
                <button class="btn btn-sm position-absolute top-0 end-0 m-2 toggle-owned-btn {% if book.have_it %}btn-success{% else %}btn-outline-light{% endif %}" 
                        data-book-id="{{ book.id }}"
                        title="{% if book.have_it %}Mark as not owned{% else %}Mark as owned{% endif %}">
                    <i class="bi bi-{% if book.have_it %}check-circle-fill{% else %}circle{% endif %}"></i>
                </button>
            </div>
            <div class="card-body">
                <h6 class="card-title">{{ book.title }}</h6>
                {% if book.subtitle %}
                    <p class="card-text text-muted small">{{ book.subtitle }}</p>
                {% endif %}
                
                <div class="mb-2">
                    {% if book.release_date %}
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ book.release_date[:4] }}
                        </small>
                    {% endif %}
                    {% if book.format %}
                        <small class="badge bg-info ms-1">{{ book.format }}</small>
                    {% endif %}
                </div>
                
                <div class="mb-2">
                    {% set sources = book.source %}
                    {% if sources %}
                        {% if '[' in sources %}
                            {% set source_list = sources.replace('[', '').replace(']', '').replace('"', '').replace("'", '').split(',') %}
                            {% for source in source_list %}
                                <span class="badge bg-secondary source-badge">{{ source.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="badge bg-secondary source-badge">{{ sources }}</span>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% if book.isbn or book.isbn13 %}
                    <small class="text-muted d-block">
                        ISBN: {{ book.isbn13 or book.isbn }}
                    </small>
                {% endif %}
                
                {% if book.asin %}
                    <small class="text-muted d-block">
                        ASIN: {{ book.asin }}
                    </small>
                {% endif %}
                
                <div class="mt-2">
                    {% if not book.have_it %}
                    <button class="btn btn-sm btn-primary w-100 mb-1 unified-search-btn" 
                            data-book-title="{{ book.title }}"
                            data-author-name="{{ author.name }}">
                        <i class="bi bi-search"></i> Search
                    </button>
                    {% endif %}
                    <div class="btn-group w-100 mb-1" role="group">
                        <button class="btn btn-sm btn-outline-secondary edit-book-btn" 
                                data-book-id="{{ book.id }}"
                                data-book-title="{{ book.title }}"
                                data-book-subtitle="{{ book.subtitle or '' }}"
                                data-book-series="{{ book.series or '' }}"
                                data-book-series-position="{{ book.series_position or '' }}"
                                data-book-isbn="{{ book.isbn or '' }}"
                                data-book-isbn13="{{ book.isbn13 or '' }}"
                                data-book-asin="{{ book.asin or '' }}"
                                data-book-release-date="{{ book.release_date or '' }}"
                                data-book-format="{{ book.format or '' }}"
                                data-book-cover-url="{{ book.cover_url or '' }}"
                                data-book-description="{{ book.description or '' }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-info search-metadata-btn"
                                data-book-id="{{ book.id }}"
                                data-book-title="{{ book.title }}"
                                data-author-name="{{ author.name }}">
                            <i class="bi bi-info-circle"></i> Find Info
                        </button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger w-100 delete-book-btn"
                            data-book-id="{{ book.id }}"
                            data-book-title="{{ book.title }}">
                        <i class="bi bi-trash"></i> Delete Book
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
        </div>
    </div>
{% endfor %}
{% else %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> No books found yet. Click "Re-scan Now" to search for books.
</div>
{% endif %}

<!-- Edit Book Modal -->
<div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBookModalLabel">Edit Book Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBookForm" method="POST">
                <input type="hidden" id="edit_book_id" name="book_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_book_title" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="edit_book_title" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_book_subtitle" class="form-label">Subtitle</label>
                                <input type="text" class="form-control" id="edit_book_subtitle" name="subtitle">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_book_series" class="form-label">Series Name</label>
                                <input type="text" class="form-control" id="edit_book_series" name="series">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_book_series_position" class="form-label">Series Position</label>
                                <input type="text" class="form-control" id="edit_book_series_position" name="series_position">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit_book_isbn" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="edit_book_isbn" name="isbn">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit_book_isbn13" class="form-label">ISBN-13</label>
                                <input type="text" class="form-control" id="edit_book_isbn13" name="isbn13">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit_book_asin" class="form-label">ASIN</label>
                                <input type="text" class="form-control" id="edit_book_asin" name="asin">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_book_release_date" class="form-label">Release Date</label>
                                <input type="text" class="form-control" id="edit_book_release_date" name="release_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_book_format" class="form-label">Format</label>
                                <select class="form-select" id="edit_book_format" name="format">
                                    <option value="">-- Select Format --</option>
                                    <option value="audiobook">Audiobook</option>
                                    <option value="ebook">eBook</option>
                                    <option value="hardcover">Hardcover</option>
                                    <option value="paperback">Paperback</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_book_cover_url" class="form-label">Cover Image URL</label>
                        <input type="url" class="form-control" id="edit_book_cover_url" name="cover_url">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_book_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_book_description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Search Metadata Modal -->
<div class="modal fade" id="searchMetadataModal" tabindex="-1" aria-labelledby="searchMetadataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchMetadataModalLabel">Search Book Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="metadataLoadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching Open Library, Google Books, and Audnexus...</p>
                </div>
                
                <div id="metadataResultsContent" style="display: none;">
                    <div class="mb-3">
                        <strong id="metadataResultsCount">0</strong> results found - Click "Use This" to update book details
                    </div>
                    <div class="row" id="metadataResultsContainer">
                    </div>
                </div>
                
                <div id="metadataNoResults" style="display: none;" class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No metadata found
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Results Modal -->
<div class="modal fade" id="searchResultsModal" tabindex="-1" aria-labelledby="searchResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchResultsModalLabel">Search Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="searchLoadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching Prowlarr and Jackett...</p>
                </div>
                
                <div id="searchResultsContent" style="display: none;">
                    <div class="mb-3">
                        <strong id="searchResultsCount">0</strong> results found
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Title</th>
                                    <th>Indexer</th>
                                    <th>Size</th>
                                    <th>Seeders</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="searchNoResults" style="display: none;" class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No results found
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for download notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="downloadToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">BookScout</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Toggle book owned status
document.querySelectorAll('.toggle-owned-btn').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        const bookId = this.getAttribute('data-book-id');
        const btn = this;
        
        fetch(`/books/${bookId}/toggle-owned`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button appearance
                if (data.have_it) {
                    btn.classList.remove('btn-outline-light');
                    btn.classList.add('btn-success');
                    btn.querySelector('i').classList.remove('bi-circle');
                    btn.querySelector('i').classList.add('bi-check-circle-fill');
                    btn.title = 'Mark as not owned';
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-light');
                    btn.querySelector('i').classList.remove('bi-check-circle-fill');
                    btn.querySelector('i').classList.add('bi-circle');
                    btn.title = 'Mark as owned';
                }
                
                // Reload page to update counts
                setTimeout(() => location.reload(), 500);
            }
        })
        .catch(error => {
            console.error('Error toggling book status:', error);
            showToast('Failed to update book status', 'danger');
        });
    });
});

// Unified search functionality
document.querySelectorAll('.unified-search-btn').forEach(button => {
    button.addEventListener('click', function() {
        const bookTitle = this.getAttribute('data-book-title');
        const authorName = this.getAttribute('data-author-name');
        const query = `${bookTitle} ${authorName}`;
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
        modal.show();
        
        // Reset modal content
        document.getElementById('searchLoadingSpinner').style.display = 'block';
        document.getElementById('searchResultsContent').style.display = 'none';
        document.getElementById('searchNoResults').style.display = 'none';
        document.getElementById('searchResultsModalLabel').textContent = `Search Results: ${bookTitle}`;
        
        // Perform search
        fetch('/api/unified-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('searchLoadingSpinner').style.display = 'none';
            
            if (data.error) {
                document.getElementById('searchNoResults').textContent = 'Error: ' + data.error;
                document.getElementById('searchNoResults').style.display = 'block';
                return;
            }
            
            if (data.count === 0) {
                document.getElementById('searchNoResults').style.display = 'block';
                return;
            }
            
            // Display results
            displaySearchResults(data.results, data.count);
        })
        .catch(error => {
            document.getElementById('searchLoadingSpinner').style.display = 'none';
            document.getElementById('searchNoResults').textContent = 'Search failed: ' + error;
            document.getElementById('searchNoResults').style.display = 'block';
        });
    });
});

function displaySearchResults(results, count) {
    document.getElementById('searchResultsCount').textContent = count;
    document.getElementById('searchResultsContent').style.display = 'block';
    
    const tbody = document.getElementById('searchResultsTableBody');
    tbody.innerHTML = '';
    
    results.forEach(result => {
        const row = document.createElement('tr');
        
        // Source badge
        const sourceCell = document.createElement('td');
        const sourceBadge = document.createElement('span');
        sourceBadge.className = result.source === 'Prowlarr' ? 'badge bg-info' : 'badge bg-warning text-dark';
        sourceBadge.textContent = result.source;
        const typeBadge = document.createElement('span');
        typeBadge.className = result.type === 'Usenet' ? 'badge bg-primary ms-1' : 'badge bg-success ms-1';
        typeBadge.textContent = result.type;
        sourceCell.appendChild(sourceBadge);
        sourceCell.appendChild(typeBadge);
        row.appendChild(sourceCell);
        
        // Title
        const titleCell = document.createElement('td');
        titleCell.textContent = result.title;
        titleCell.style.maxWidth = '400px';
        titleCell.style.overflow = 'hidden';
        titleCell.style.textOverflow = 'ellipsis';
        titleCell.title = result.title;
        row.appendChild(titleCell);
        
        // Indexer
        const indexerCell = document.createElement('td');
        indexerCell.textContent = result.indexer || 'N/A';
        row.appendChild(indexerCell);
        
        // Size
        const sizeCell = document.createElement('td');
        sizeCell.textContent = result.size_display || 'N/A';
        row.appendChild(sizeCell);
        
        // Seeders (only for torrents)
        const seedersCell = document.createElement('td');
        if (result.type === 'Torrent') {
            const seedersSpan = document.createElement('span');
            seedersSpan.className = result.seeders > 10 ? 'text-success fw-bold' : (result.seeders > 0 ? 'text-warning' : 'text-danger');
            seedersSpan.textContent = result.seeders;
            seedersCell.appendChild(seedersSpan);
        } else {
            seedersCell.textContent = 'N/A';
        }
        row.appendChild(seedersCell);
        
        // Action button
        const actionCell = document.createElement('td');
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn btn-sm btn-primary';
        downloadBtn.innerHTML = '<i class="bi bi-download"></i> Download';
        downloadBtn.onclick = () => sendToDownloadClient(result);
        actionCell.appendChild(downloadBtn);
        row.appendChild(actionCell);
        
        tbody.appendChild(row);
    });
}

function sendToDownloadClient(result) {
    const downloadUrl = result.magnet_url || result.download_url;
    
    if (!downloadUrl) {
        showToast('Error: No download URL available', 'danger');
        return;
    }
    
    fetch('/api/download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            download_url: downloadUrl,
            title: result.title,
            type: result.type
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Download failed: ' + error, 'danger');
    });
}

function showToast(message, type) {
    const toastEl = document.getElementById('downloadToast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toastMessage.className = 'toast-body';
    
    if (type === 'success') {
        toastMessage.classList.add('bg-success', 'text-white');
    } else {
        toastMessage.classList.add('bg-danger', 'text-white');
    }
    
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

// Edit book functionality
document.querySelectorAll('.edit-book-btn').forEach(button => {
    button.addEventListener('click', function() {
        // Get book data from button data attributes
        const bookId = this.getAttribute('data-book-id');
        const bookTitle = this.getAttribute('data-book-title');
        const bookSubtitle = this.getAttribute('data-book-subtitle');
        const bookSeries = this.getAttribute('data-book-series');
        const bookSeriesPosition = this.getAttribute('data-book-series-position');
        const bookIsbn = this.getAttribute('data-book-isbn');
        const bookIsbn13 = this.getAttribute('data-book-isbn13');
        const bookAsin = this.getAttribute('data-book-asin');
        const bookReleaseDate = this.getAttribute('data-book-release-date');
        const bookFormat = this.getAttribute('data-book-format');
        const bookCoverUrl = this.getAttribute('data-book-cover-url');
        const bookDescription = this.getAttribute('data-book-description');
        
        // Populate form fields
        document.getElementById('edit_book_id').value = bookId;
        document.getElementById('edit_book_title').value = bookTitle || '';
        document.getElementById('edit_book_subtitle').value = bookSubtitle || '';
        document.getElementById('edit_book_series').value = bookSeries || '';
        document.getElementById('edit_book_series_position').value = bookSeriesPosition || '';
        document.getElementById('edit_book_isbn').value = bookIsbn || '';
        document.getElementById('edit_book_isbn13').value = bookIsbn13 || '';
        document.getElementById('edit_book_asin').value = bookAsin || '';
        document.getElementById('edit_book_release_date').value = bookReleaseDate || '';
        document.getElementById('edit_book_format').value = bookFormat || '';
        document.getElementById('edit_book_cover_url').value = bookCoverUrl || '';
        document.getElementById('edit_book_description').value = bookDescription || '';
        
        // Set form action
        document.getElementById('editBookForm').action = `/books/${bookId}/edit`;
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('editBookModal'));
        modal.show();
    });
});

// Edit book form submission
document.getElementById('editBookForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const bookId = document.getElementById('edit_book_id').value;
    
    fetch(`/books/${bookId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Book updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + (data.error || 'Failed to update book'), 'danger');
        }
    })
    .catch(error => {
        showToast('Update failed: ' + error, 'danger');
    });
});

// Search metadata functionality
document.querySelectorAll('.search-metadata-btn').forEach(button => {
    button.addEventListener('click', function() {
        const bookId = this.getAttribute('data-book-id');
        const bookTitle = this.getAttribute('data-book-title');
        const authorName = this.getAttribute('data-author-name');
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('searchMetadataModal'));
        modal.show();
        
        // Reset modal content
        document.getElementById('metadataLoadingSpinner').style.display = 'block';
        document.getElementById('metadataResultsContent').style.display = 'none';
        document.getElementById('metadataNoResults').style.display = 'none';
        document.getElementById('searchMetadataModalLabel').textContent = `Find Metadata: ${bookTitle}`;
        
        // Perform metadata search
        fetch(`/books/${bookId}/search-metadata`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: bookTitle,
                author: authorName
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('metadataLoadingSpinner').style.display = 'none';
            
            if (data.error) {
                document.getElementById('metadataNoResults').textContent = 'Error: ' + data.error;
                document.getElementById('metadataNoResults').style.display = 'block';
                return;
            }
            
            if (!data.results || data.results.length === 0) {
                document.getElementById('metadataNoResults').style.display = 'block';
                return;
            }
            
            // Display results
            displayMetadataResults(data.results, bookId);
        })
        .catch(error => {
            document.getElementById('metadataLoadingSpinner').style.display = 'none';
            document.getElementById('metadataNoResults').textContent = 'Search failed: ' + error;
            document.getElementById('metadataNoResults').style.display = 'block';
        });
    });
});

function displayMetadataResults(results, bookId) {
    document.getElementById('metadataResultsCount').textContent = results.length;
    document.getElementById('metadataResultsContent').style.display = 'block';
    
    const container = document.getElementById('metadataResultsContainer');
    container.innerHTML = '';
    
    results.forEach((result, index) => {
        const card = document.createElement('div');
        card.className = 'col-md-4 mb-3';
        
        // Escape HTML in text fields to prevent XSS
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card h-100';
        
        // Add cover image if available
        if (result.cover_url) {
            const img = document.createElement('img');
            img.src = result.cover_url;
            img.className = 'card-img-top';
            img.style.maxHeight = '300px';
            img.style.objectFit = 'contain';
            img.alt = result.title;
            cardDiv.appendChild(img);
        }
        
        // Card body
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        const title = document.createElement('h6');
        title.className = 'card-title';
        title.textContent = result.title;
        cardBody.appendChild(title);
        
        if (result.subtitle) {
            const subtitle = document.createElement('p');
            subtitle.className = 'card-text text-muted small';
            subtitle.textContent = result.subtitle;
            cardBody.appendChild(subtitle);
        }
        
        const details = document.createElement('div');
        details.className = 'small';
        details.innerHTML = `
            <strong>Source:</strong> <span class="badge bg-info">${result.source}</span><br>
            ${result.series ? `<strong>Series:</strong> ${escapeHtml(result.series)}${result.series_position ? ` #${escapeHtml(result.series_position)}` : ''}<br>` : ''}
            ${result.isbn ? `<strong>ISBN:</strong> ${escapeHtml(result.isbn)}<br>` : ''}
            ${result.isbn13 ? `<strong>ISBN-13:</strong> ${escapeHtml(result.isbn13)}<br>` : ''}
            ${result.asin ? `<strong>ASIN:</strong> ${escapeHtml(result.asin)}<br>` : ''}
            ${result.release_date ? `<strong>Released:</strong> ${escapeHtml(result.release_date)}<br>` : ''}
            ${result.format ? `<strong>Format:</strong> ${escapeHtml(result.format)}<br>` : ''}
        `;
        cardBody.appendChild(details);
        
        if (result.description) {
            const desc = document.createElement('p');
            desc.className = 'card-text small mt-2';
            desc.style.maxHeight = '100px';
            desc.style.overflow = 'hidden';
            desc.textContent = result.description.substring(0, 150) + '...';
            cardBody.appendChild(desc);
        }
        
        cardDiv.appendChild(cardBody);
        
        // Card footer with button
        const cardFooter = document.createElement('div');
        cardFooter.className = 'card-footer';
        
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-primary w-100';
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Use This';
        btn.dataset.bookId = bookId;
        // Store metadata object directly on the button element
        btn.metadataObject = result;
        btn.addEventListener('click', function() {
            applyMetadata(this.dataset.bookId, this.metadataObject);
        });
        
        cardFooter.appendChild(btn);
        cardDiv.appendChild(cardFooter);
        
        card.appendChild(cardDiv);
        container.appendChild(card);
    });
}

function applyMetadata(bookId, metadata) {
    fetch(`/books/${bookId}/apply-metadata`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(metadata)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Metadata applied successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + (data.error || 'Failed to apply metadata'), 'danger');
        }
    })
    .catch(error => {
        showToast('Failed to apply metadata: ' + error, 'danger');
    });
}

// Delete book functionality
document.querySelectorAll('.delete-book-btn').forEach(button => {
    button.addEventListener('click', function() {
        const bookId = this.getAttribute('data-book-id');
        const bookTitle = this.getAttribute('data-book-title');
        
        if (confirm(`Are you sure you want to delete "${bookTitle}"?\n\nThis will permanently remove it from this author.`)) {
            fetch('/books/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `book_ids[]=${bookId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Book deleted successfully', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast('Error: ' + (data.error || 'Failed to delete book'), 'danger');
                }
            })
            .catch(error => {
                showToast('Failed to delete book: ' + error, 'danger');
            });
        }
    });
});
</script>
{% endblock %}
