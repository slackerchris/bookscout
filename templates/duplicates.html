{% extends "base.html" %}

{% block title %}Manage Duplicates - {{ author.name }} - BookScout{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Authors</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('view_author', author_id=author.id) }}">{{ author.name }}</a></li>
                <li class="breadcrumb-item active">Duplicates</li>
            </ol>
        </nav>
        <h1>Manage Duplicates - {{ author.name }}</h1>
        <p class="text-muted">Review and merge or delete duplicate books</p>
    </div>
</div>

{% if duplicate_groups %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> Found <strong>{{ duplicate_groups|length }}</strong> groups of potential duplicates
</div>

{% for group in duplicate_groups %}
{% set group_index = loop.index0 %}
<div class="card mb-4">
    <div class="card-header">
        <h5>Duplicate Group {{ loop.index }}</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for book in group %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input book-checkbox" 
                                   type="checkbox" 
                                   value="{{ book.id }}" 
                                   data-group="{{ group_index }}"
                                   id="book-{{ book.id }}">
                            <label class="form-check-label" for="book-{{ book.id }}">
                                <strong>Select</strong>
                            </label>
                        </div>
                        
                        {% if book.cover_url %}
                        <img src="{{ book.cover_url }}" class="img-thumbnail mb-2" style="max-height: 150px;" alt="{{ book.title }}">
                        {% endif %}
                        
                        <h6 class="card-title">{{ book.title }}</h6>
                        
                        {% if book.subtitle %}
                        <p class="card-text text-muted small">{{ book.subtitle }}</p>
                        {% endif %}
                        
                        <dl class="row small mb-0">
                            <dt class="col-sm-4">ID:</dt>
                            <dd class="col-sm-8">{{ book.id }}</dd>
                            
                            {% if book.isbn13 %}
                            <dt class="col-sm-4">ISBN13:</dt>
                            <dd class="col-sm-8">{{ book.isbn13 }}</dd>
                            {% endif %}
                            
                            {% if book.isbn %}
                            <dt class="col-sm-4">ISBN:</dt>
                            <dd class="col-sm-8">{{ book.isbn }}</dd>
                            {% endif %}
                            
                            {% if book.asin %}
                            <dt class="col-sm-4">ASIN:</dt>
                            <dd class="col-sm-8">{{ book.asin }}</dd>
                            {% endif %}
                            
                            {% if book.series %}
                            <dt class="col-sm-4">Series:</dt>
                            <dd class="col-sm-8">{{ book.series }} #{{ book.series_position }}</dd>
                            {% endif %}
                            
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                {% if book.have_it %}
                                <span class="badge bg-success">In Library</span>
                                {% else %}
                                <span class="badge bg-secondary">Not Owned</span>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Source:</dt>
                            <dd class="col-sm-8">{{ book.source }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary merge-btn" data-group="{{ group_index }}">
                <i class="bi bi-arrow-left-right"></i> Merge Selected
            </button>
            <button class="btn btn-danger delete-btn" data-group="{{ group_index }}">
                <i class="bi bi-trash"></i> Delete Selected
            </button>
            <small class="text-muted align-self-center ms-2">
                Select one to keep (merge) or multiple to delete
            </small>
        </div>
    </div>
</div>
{% endfor %}

{% else %}
<div class="alert alert-success">
    <i class="bi bi-check-circle"></i> No duplicates found! All books appear to be unique.
</div>
<a href="{{ url_for('view_author', author_id=author.id) }}" class="btn btn-primary">
    <i class="bi bi-arrow-left"></i> Back to Author
</a>
{% endif %}

<!-- Toast for notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">BookScout</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Merge books
document.querySelectorAll('.merge-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const groupId = this.getAttribute('data-group');
        const checkboxes = document.querySelectorAll(`.book-checkbox[data-group="${groupId}"]:checked`);
        
        if (checkboxes.length < 2) {
            showToast('Please select at least 2 books to merge (one to keep, others will be merged into it)', 'warning');
            return;
        }
        
        // Ask which one to keep as primary
        const bookIds = Array.from(checkboxes).map(cb => cb.value);
        const message = `Which book should be the primary (kept) record?\n\n${Array.from(checkboxes).map((cb, i) => `${i+1}. ID ${cb.value}`).join('\n')}`;
        const choice = prompt(message + '\n\nEnter the number (1-' + bookIds.length + '):');
        
        if (!choice || isNaN(choice) || choice < 1 || choice > bookIds.length) {
            showToast('Merge cancelled', 'info');
            return;
        }
        
        const primaryId = bookIds[parseInt(choice) - 1];
        const duplicateIds = bookIds.filter(id => id !== primaryId);
        
        if (!confirm(`Merge ${duplicateIds.length} books into book ID ${primaryId}?\n\nThe other books will be deleted and their data merged into the primary book.`)) {
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('primary_id', primaryId);
        duplicateIds.forEach(id => formData.append('duplicate_ids[]', id));
        
        fetch('/books/merge', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showToast('Merge failed: ' + error, 'danger');
        });
    });
});

// Delete books
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const groupId = this.getAttribute('data-group');
        const checkboxes = document.querySelectorAll(`.book-checkbox[data-group="${groupId}"]:checked`);
        
        if (checkboxes.length === 0) {
            showToast('Please select at least one book to delete', 'warning');
            return;
        }
        
        const bookIds = Array.from(checkboxes).map(cb => cb.value);
        
        if (!confirm(`Delete ${bookIds.length} book(s)?\n\nThis action cannot be undone.`)) {
            return;
        }
        
        // Create form data
        const formData = new FormData();
        bookIds.forEach(id => formData.append('book_ids[]', id));
        
        fetch('/books/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showToast('Delete failed: ' + error, 'danger');
        });
    });
});

function showToast(message, type) {
    const toastEl = document.getElementById('actionToast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toastMessage.className = 'toast-body';
    
    if (type === 'success') {
        toastMessage.classList.add('bg-success', 'text-white');
    } else if (type === 'warning') {
        toastMessage.classList.add('bg-warning', 'text-dark');
    } else if (type === 'info') {
        toastMessage.classList.add('bg-info', 'text-white');
    } else {
        toastMessage.classList.add('bg-danger', 'text-white');
    }
    
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}
</script>
{% endblock %}
